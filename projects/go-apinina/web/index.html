<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Upload de Imagem</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            .container {
                max-width: 400px;
                margin: auto;
                padding: 20px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }
            .message {
                margin-top: 15px;
                padding: 10px;
                border-radius: 3px;
            }
            .success {
                background-color: #d4edda;
                color: #155724;
                border-color: #c3e6cb;
            }
            .error {
                background-color: #f8d7da;
                color: #721c24;
                border-color: #f5c6cb;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Enviar Imagem para API Go</h1>

            <form id="uploadForm">
                <label for="imageFile">Selecione uma Imagem:</label><br /><br />
                <input
                    type="file"
                    id="imageFile"
                    name="file"
                    accept="image/*"
                    required
                /><br /><br />
                <button type="submit">Enviar Imagem</button>
            </form>

            <div id="message" class="message" style="display: none"></div>
        </div>

        <script>
            document
                .getElementById("uploadForm")
                .addEventListener("submit", async function (event) {
                    event.preventDefault(); // Evita o envio padrão do formulário

                    const form = event.target;
                    const fileInput = document.getElementById("imageFile");
                    const messageDiv = document.getElementById("message");

                    messageDiv.style.display = "none";
                    messageDiv.textContent = "";
                    messageDiv.className = "message";

                    if (fileInput.files.length === 0) {
                        messageDiv.textContent =
                            "Por favor, selecione um arquivo.";
                        messageDiv.className = "message error";
                        messageDiv.style.display = "block";
                        return;
                    }

                    // Cria um objeto FormData para empacotar o arquivo
                    const formData = new FormData();
                    formData.append("filename", fileInput.files[0]);

                    try {
                        // Envia a requisição POST para sua API Go
                        // Futuramente eu poderia melhorar isso aqui jogando para o S3 e com um consumer trabalhar na imagem de forma async (quando chegar no htmx pensamos nisso)
                        const response = await fetch(
                            "http://localhost:8080/upload",
                            {
                                method: "POST",
                                body: formData, // Fetch API se encarrega do cabeçalho Content-Type: multipart/form-data
                            },
                        );

                        if (response.ok) {
                            const result = await response.json();
                            messageDiv.textContent =
                                "Sucesso no Upload! Resposta da API: " +
                                (result.message || "Sem mensagem.");
                            messageDiv.className = "message success";
                        } else {
                            const errorText = await response.text();
                            messageDiv.textContent =
                                "Erro no Upload. Status: " +
                                response.status +
                                ". Detalhes: " +
                                errorText;
                            messageDiv.className = "message error";
                        }
                    } catch (error) {
                        messageDiv.textContent =
                            "Erro de rede ou na requisição: " + error.message;
                        messageDiv.className = "message error";
                    }

                    messageDiv.style.display = "block";
                });
        </script>
    </body>
</html>
